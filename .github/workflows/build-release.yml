name: Build Release

on:
  workflow_dispatch:       # кнопка "Run workflow"
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # Install CMake
      # -----------------------------
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v2

      # -----------------------------
      # Download Official OIDN
      # -----------------------------
      - name: Download OIDN
        shell: bash
        env:
          OIDN_VERSION: "2.3.3"
        run: |
          echo "Preparing Official OIDN v${OIDN_VERSION}..."
          mkdir -p thirdparty/oidn
          cd thirdparty/oidn

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            URL="https://github.com/OpenImageDenoise/oidn/releases/download/v${OIDN_VERSION}/oidn-${OIDN_VERSION}.x64.windows.zip"
            curl -L -o oidn.zip "$URL"
            unzip oidn.zip
            mv oidn-${OIDN_VERSION}/include ./include
            mv oidn-${OIDN_VERSION}/lib ./lib
            rm -rf oidn-${OIDN_VERSION} oidn.zip
          else
            URL="https://github.com/OpenImageDenoise/oidn/releases/download/v${OIDN_VERSION}/oidn-${OIDN_VERSION}.x86_64.macos.tar.gz"
            curl -L -o oidn.tar.gz "$URL"
            tar -xzf oidn.tar.gz
            mv oidn-${OIDN_VERSION}/include ./include
            mv oidn-${OIDN_VERSION}/lib ./lib
            rm -rf oidn-${OIDN_VERSION} oidn.tar.gz
          fi

      # -----------------------------
      # Configure CMake
      # -----------------------------
      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      # -----------------------------
      # Build
      # -----------------------------
      - name: Build
        run: cmake --build build --config Release --parallel

      # -----------------------------
      # Smoke test (--help)
      # -----------------------------
      - name: Smoke test (Windows)
        if: matrix.os == 'windows-latest'
        run: ./build/Release/etx-tracer.exe --help
        shell: bash

      - name: Smoke test (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          chmod +x build/etx-tracer
          ./build/etx-tracer --help
        shell: bash

      # -----------------------------
      # Render minimal test scene
      # -----------------------------
      - name: Create test scene
        run: |
          mkdir -p tests
          cat <<EOF > tests/test_scene.json
          {
            "camera": {
              "type": "perspective",
              "fov": 45,
              "position": [0,0,3],
              "look_at": [0,0,0]
            },
            "objects": [
              {
                "type": "sphere",
                "radius": 1,
                "position": [0,0,0],
                "material": {
                  "type": "diffuse",
                  "albedo": [0.7,0.7,0.7]
                }
              }
            ],
            "lights": [
              {
                "type": "point",
                "position": [3,3,3],
                "intensity": [4,4,4]
              }
            ]
          }
          EOF

      - name: Render test (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          ./build/Release/etx-tracer.exe tests/test_scene.json test.png
          if [ ! -f test.png ]; then exit 1; fi
        shell: bash

      - name: Render test (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          ./build/etx-tracer tests/test_scene.json test.png
          if [ ! -f test.png ]; then exit 1; fi
        shell: bash

      # -----------------------------
      # Package artifacts
      # -----------------------------
      - name: Package
        shell: bash
        run: |
          mkdir -p artifacts
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cp build/Release/*.exe artifacts/
          else
            cp build/*.app -r artifacts/ 2>/dev/null || true
            cp build/* artifacts/ 2>/dev/null || true
          fi
          zip -r release-${{ matrix.os }}.zip artifacts

      # -----------------------------
      # Upload Artifact
      # -----------------------------
      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: release-${{ matrix.os }}.zip
